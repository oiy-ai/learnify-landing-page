name: Deploy to Server with BT Panel

on:
  push:
    branches: [main]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: PROD
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest
        
    - name: Install dependencies
      run: pnpm install
      
    - name: Deploy Convex to Production
      env:
        CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}
      run: npx convex deploy
      
    - name: Build application
      env:
        VITE_CLERK_PUBLISHABLE_KEY: ${{ secrets.VITE_CLERK_PUBLISHABLE_KEY }}
        VITE_CONVEX_URL: ${{ secrets.VITE_CONVEX_URL }}
        CONVEX_DEPLOYMENT: ${{ secrets.CONVEX_DEPLOYMENT }}
        FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
      run: npm run build
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: build/
        
    - name: Upload build to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        source: "build/*"
        target: "/tmp/ringbot-build/"
        strip_components: 1
        
    - name: Deploy to Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          set -e
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°å®å¡”é¢æ¿æœåŠ¡å™¨..."
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export PATH="/usr/local/bin:/usr/bin:/bin:$PATH"
          export NODE_PATH="/usr/local/lib/node_modules:$NODE_PATH"
          
          # 1. åˆ›å»ºåº”ç”¨ç›®å½•ç»“æ„
          echo "ğŸ“ åˆ›å»ºç›®å½•ç»“æ„..."
          mkdir -p /www/wwwroot/ringbot
          mkdir -p /www/wwwroot/ringbot/logs
          mkdir -p /www/backup/ringbot
          
          # 2. è®¾ç½®æƒé™
          chown -R www:www /www/wwwroot/ringbot
          chmod -R 755 /www/wwwroot/ringbot
          
          # 3. å¤‡ä»½ç°æœ‰ç‰ˆæœ¬
          if [ -d "/www/wwwroot/ringbot/build" ]; then
            echo "ğŸ“¦ å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
            cp -r /www/wwwroot/ringbot/build /www/backup/ringbot/build-$(date +%Y%m%d-%H%M%S)
          fi
          
          # 4. éƒ¨ç½²æ„å»ºäº§ç‰©
          echo "ğŸ“¦ éƒ¨ç½²æ„å»ºäº§ç‰©..."
          rm -rf /www/wwwroot/ringbot/build
          mv /tmp/ringbot-build /www/wwwroot/ringbot/build
          
          # 5. å…‹éš†é…ç½®æ–‡ä»¶ï¼ˆä»…é¦–æ¬¡æˆ–éœ€è¦æ—¶ï¼‰
          if [ ! -f "/www/wwwroot/ringbot/package.json" ]; then
            echo "ğŸ“¥ ä¸‹è½½é…ç½®æ–‡ä»¶..."
            cd /tmp
            git clone https://${{ secrets.DEPLOY_PAT }}@github.com/${{ github.repository }}.git ringbot-config
            cp ringbot-config/package.json /www/wwwroot/ringbot/
            cp ringbot-config/ecosystem.config.cjs /www/wwwroot/ringbot/ 2>/dev/null || true
            rm -rf ringbot-config
          fi
          
          # 6. è®¾ç½®æƒé™
          chown -R www:www /www/wwwroot/ringbot
          
          # 7. æ— éœ€å®‰è£… Node.js - ç›´æ¥ä½¿ç”¨ Nginx æ‰˜ç®¡é™æ€æ–‡ä»¶
          
          # 8. åˆ›å»º Nginx é…ç½®
          echo "ğŸŒ é…ç½® Nginx..."
          cat > /www/server/panel/vhost/nginx/ringbot.conf << 'EOF'
          server {
              listen 80 default_server;
              server_name ${{ secrets.DOMAIN_NAME }};
              
              root /www/wwwroot/ringbot/build/client;
              index index.html;
              
              access_log /www/wwwlogs/ringbot_access.log;
              error_log /www/wwwlogs/ringbot_error.log;
              
              # å®‰å…¨å¤´
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-XSS-Protection "1; mode=block" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header Referrer-Policy "no-referrer-when-downgrade" always;
              
              # é™æ€æ–‡ä»¶ç¼“å­˜
              location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|otf|eot)$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
                  try_files $uri =404;
              }
              
              # SPA è·¯ç”±å¤„ç† - æ‰€æœ‰è·¯ç”±éƒ½è¿”å› index.html
              location / {
                  try_files $uri $uri/ /index.html;
              }
              
              # å¥åº·æ£€æŸ¥ç«¯ç‚¹
              location /health {
                  access_log off;
                  return 200 "healthy\n";
                  add_header Content-Type text/plain;
              }
              
              # é˜²æ­¢è®¿é—®éšè—æ–‡ä»¶
              location ~ /\. {
                  deny all;
              }
          }
          EOF
          
          # 9. åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
          echo "âš™ï¸ é…ç½®ç¯å¢ƒå˜é‡..."
          cat > /www/wwwroot/ringbot/.env << 'EOF'
          PORT=3001
          VITE_CONVEX_URL=${{ secrets.VITE_CONVEX_URL }}
          CONVEX_DEPLOYMENT=${{ secrets.CONVEX_DEPLOYMENT }}
          VITE_CLERK_PUBLISHABLE_KEY=${{ secrets.VITE_CLERK_PUBLISHABLE_KEY }}
          FRONTEND_URL=${{ secrets.FRONTEND_URL }}
          EOF
          
          # 10. è®¾ç½®æ–‡ä»¶æƒé™
          chown -R www:www /www/wwwroot/ringbot
          
          # 11. åœæ­¢å¹¶åˆ é™¤ PM2 åº”ç”¨ï¼ˆä¸å†éœ€è¦ï¼‰
          echo "ğŸ”„ æ¸…ç† PM2 åº”ç”¨..."
          PM2_CMD=""
          for path in "/usr/local/bin/pm2" "/usr/bin/pm2" "/root/.npm-global/bin/pm2" "pm2"; do
            if command -v $path &> /dev/null; then
              PM2_CMD=$path
              break
            fi
          done
          
          if [ -n "$PM2_CMD" ] && $PM2_CMD list | grep -q "ringbot"; then
            echo "åœæ­¢å¹¶åˆ é™¤ PM2 åº”ç”¨..."
            $PM2_CMD stop ringbot
            $PM2_CMD delete ringbot
            $PM2_CMD save
          else
            echo "æœªæ‰¾åˆ° PM2 åº”ç”¨ï¼Œè·³è¿‡æ¸…ç†"
          fi
          
          # 12. æµ‹è¯•å¹¶é‡è½½ Nginx
          echo "ğŸŒ é‡è½½ Nginx..."
          nginx -t && nginx -s reload
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ“Š åº”ç”¨çŠ¶æ€ï¼š"
          pm2 status
    
    - name: Health Check
      run: |
        sleep 30
        curl -f http://${{ secrets.SERVER_HOST }}/health || exit 1